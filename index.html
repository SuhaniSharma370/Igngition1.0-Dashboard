<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Rider Telemetry Live</title>

  <!-- Styles -->
  <style>
    :root {
      --primary: #0055cc;
      --danger: #dc2626;
      --success: #16a34a;
      --warning: #f59e0b;
      --dark: #1f2937;
      --light: #f8fafc;
      --gray: #64748b;
      --border: #e2e8f0;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f0f7ff 0%, #e0ecff 100%);
      color: var(--dark);
      min-height: 100vh;
      padding: 1rem;
      line-height: 1.5;
    }

    header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    h1 {
      font-size: 1.8rem;
      font-weight: 600;
      color: var(--primary);
    }

    .status {
      display: inline-block;
      padding: 0.35rem 0.75rem;
      border-radius: 2rem;
      font-size: 0.85rem;
      font-weight: 600;
      margin-top: 0.5rem;
    }

    .status.connected { background: rgba(22, 163, 74, 0.1); color: var(--success); }
    .status.disconnected { background: rgba(220, 38, 38, 0.1); color: var(--danger); }

    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
      margin: 1.5rem 0;
    }

    .metric {
      background: white;
      padding: 1.2rem;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      text-align: center;
      border: 1px solid var(--border);
    }

    .metric h3 {
      font-size: 2.2rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.25rem;
    }

    .metric p {
      font-size: 0.9rem;
      color: var(--gray);
      font-weight: 500;
    }

    .lean-display {
      font-size: 1.8rem !important;
      color: #7c3aed;
    }

    .chart-container, #map {
      background: white;
      border-radius: 16px;
      padding: 1rem;
      margin: 1.5rem 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border: 1px solid var(--border);
    }

    #map {
      height: 45vh;
      border-radius: 16px;
    }

    canvas {
      max-height: 200px;
    }

    .alert {
      position: fixed;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--danger);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      font-weight: 600;
      box-shadow: 0 10px 25px rgba(220, 38, 38, 0.3);
      z-index: 1000;
      animation: pulse 0.6s ease-in-out;
      display: none;
    }

    @keyframes pulse {
      0% { transform: translateX(-50%) scale(0.9); }
      50% { transform: translateX(-50%) scale(1.05); }
      100% { transform: translateX(-50%) scale(1); }
    }

    .controls {
      text-align: center;
      margin: 1rem 0;
    }

    button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      margin: 0 0.5rem;
      transition: all 0.2s;
    }

    button:hover {
      background: #0044aa;
      transform: translateY(-2px);
    }

    button.danger {
      background: var(--danger);
    }

    .info {
      font-size: 0.85rem;
      color: var(--gray);
      text-align: center;
      margin-top: 1rem;
    }

    @media (max-width: 480px) {
      h1 { font-size: 1.5rem; }
      .metric h3 { font-size: 1.8rem; }
      canvas { max-height: 150px; }
    }
  </style>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>
<body>

  <header>
    <h1>Rider Telemetry</h1>
    <div class="status" id="connectionStatus">Connecting...</div>
  </header>

  <div class="controls">
    <button id="connectBtn">Connect to Phyphox</button>
    <button id="resetBtn" class="danger">Reset Path</button>
  </div>

  <div class="metrics">
    <div class="metric">
      <h3 id="speed">0</h3>
      <p>Speed (km/h)</p>
    </div>
    <div class="metric">
      <h3 id="lean" class="lean-display">0°</h3>
      <p>Lean Angle</p>
    </div>
    <div class="metric">
      <h3 id="acc">0.0</h3>
      <p>Accel X (m/s²)</p>
    </div>
    <div class="metric">
      <h3 id="impact">—</h3>
      <p>Impact</p>
    </div>
  </div>

  <div class="chart-container">
    <canvas id="accChart"></canvas>
  </div>

  <div id="map"></div>

  <div class="alert" id="crashAlert">
    HIGH IMPACT DETECTED! Check rider immediately.
  </div>

  <div class="info">
    Mount sensor phone on <strong>upper chest</strong> or <strong>helmet</strong>. Use Phyphox → Remote Access.
  </div>

  <script>
    // === CONFIG ===
    const IMPACT_THRESHOLD = 30.0;  // ~3g
    const GYRO_THRESHOLD = 300;     // deg/s (tune based on your experiment)
    const MAX_DATA_POINTS = 50;

    // === DOM Elements ===
    const speedEl = document.getElementById('speed');
    const leanEl = document.getElementById('lean');
    const accEl = document.getElementById('acc');
    const impactEl = document.getElementById('impact');
    const statusEl = document.getElementById('connectionStatus');
    const crashAlert = document.getElementById('crashAlert');
    const connectBtn = document.getElementById('connectBtn');
    const resetBtn = document.getElementById('resetBtn');

    // === State ===
    let phyphoxUrl = null;
    let interval = null;
    let isConnected = false;

    // === Leaflet Map ===
    const map = L.map('map').setView([0, 0], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let riderPath = L.polyline([], { color: '#0055cc', weight: 5, opacity: 0.8 }).addTo(map);
    let riderMarker = L.circleMarker([0, 0], {
      radius: 8,
      fillColor: '#0055cc',
      color: '#003366',
      weight: 2,
      opacity: 1,
      fillOpacity: 0.9
    }).addTo(map);

    // === Chart.js ===
    const ctx = document.getElementById('accChart').getContext('2d');
    const accChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Accel X (m/s²)',
          data: [],
          borderColor: '#0055cc',
          backgroundColor: 'rgba(0, 85, 204, 0.1)',
          fill: true,
          tension: 0.3,
          pointRadius: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: false },
          x: { display: false }
        }
      }
    });

    // === Functions ===
    function connect() {
      phyphoxUrl = prompt("Enter Phyphox Remote Access URL (e.g., http://192.168.1.34:8080)")?.trim();
      if (!phyphoxUrl) return;

      statusEl.textContent = "Connecting...";
      statusEl.className = "status disconnected";
      testConnection();
    }

    function testConnection() {
      fetch(phyphoxUrl)
        .then(r => r.json())
        .then(() => {
          isConnected = true;
          statusEl.textContent = "Connected";
          statusEl.className = "status connected";
          startStreaming();
        })
        .catch(() => {
          statusEl.textContent = "Failed. Retrying...";
          setTimeout(testConnection, 2000);
        });
    }

    function startStreaming() {
      if (interval) clearInterval(interval);
      interval = setInterval(updateTelemetry, 200); // 5 Hz
    }

    function updateTelemetry() {
      if (!isConnected) return;

      fetch(phyphoxUrl)
        .then(r => r.json())
        .then(data => {
          // Extract latest values
          const ax = data.buffer.accX?.last ?? 0;
          const ay = data.buffer.accY?.last ?? 0;
          const az = data.buffer.accZ?.last ?? 0;
          const speed = (data.buffer.speed?.last ?? 0) * 3.6; // m/s → km/h
          const lat = data.buffer.latitude?.last;
          const lon = data.buffer.longitude?.last;
          const gyroX = data.buffer.rotX?.last ?? 0;

          // Update UI
          speedEl.textContent = speed.toFixed(1);
          accEl.textContent = ax.toFixed(2);

          // Lean Angle: atan2(lateral accel, gravity) — assumes Z is up
          const lean = Math.atan2(ax, Math.sqrt(ay * ay + 9.81 * 9.81)) * (180 / Math.PI);
          leanEl.textContent = lean.toFixed(1) + "°";

          // Resultant acceleration
          const res = Math.sqrt(ax*ax + ay*ay + az*az);
          impactEl.textContent = res.toFixed(1);

          // Chart update
          accChart.data.labels.push('');
          accChart.data.datasets[0].data.push(ax);
          if (accChart.data.labels.length > MAX_DATA_POINTS) {
            accChart.data.labels.shift();
            accChart.data.datasets[0].data.shift();
          }
          accChart.update('quiet');

          // GPS Path
          if (lat && lon) {
            const latLng = [lat, lon];
            riderPath.addLatLng(latLng);
            riderMarker.setLatLng(latLng);
            map.setView(latLng, map.getZoom());
          }

          // === CRASH / IMPACT DETECTION ===
          if (res > IMPACT_THRESHOLD || Math.abs(gyroX) > GYRO_THRESHOLD) {
            triggerCrashAlert();
          }
        })
        .catch(() => {
          isConnected = false;
          statusEl.textContent = "Lost Connection";
          statusEl.className = "status disconnected";
          clearInterval(interval);
          setTimeout(testConnection, 3000);
        });
    }

    function triggerCrashAlert() {
      crashAlert.style.display = 'block';
      setTimeout(() => {
        crashAlert.style.display = 'none';
      }, 5000);

      // Optional: vibrate (mobile only)
      if (navigator.vibrate) {
        navigator.vibrate([500, 300, 500]);
      }

      // Optional: play sound
      const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgn2u2fV
      // (add beep sound or use external)
    }

    function resetPath() {
      riderPath.setLatLngs([]);
      map.setView([0, 0], 2);
    }

    // === Event Listeners ===
    connectBtn.addEventListener('click', connect);
    resetBtn.addEventListener('click', resetPath);

    // Auto-connect if URL in query string (optional)
    const urlParams = new URLSearchParams(window.location.search);
    const autoUrl = urlParams.get('phyphox');
    if (autoUrl) {
      phyphoxUrl = autoUrl;
      testConnection();
    } else {
      connect();
    }
  </script>
</body>
</html>
